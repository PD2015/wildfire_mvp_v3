#!/bin/sh
# Pre-commit hook to auto-format, analyze, and check for API keys
# This ensures all commits have properly formatted code and no secrets
#
# Setup: git config core.hooksPath .githooks
# Bypass: git commit --no-verify (not recommended)

echo "üîç Running dart format..."

# Format all Dart files
dart format .

# Add any formatted files back to the staging area
git add -u

echo "‚úÖ Code formatting complete"
echo ""
echo "üîç Running flutter analyze..."

# Run static analysis (only if Flutter is available)
if command -v flutter >/dev/null 2>&1; then
  flutter analyze --no-fatal-infos
  ANALYZE_EXIT=$?
  
  if [ $ANALYZE_EXIT -ne 0 ]; then
    echo ""
    echo "‚ùå Flutter analyze found issues!"
    echo "   Please fix the issues above before committing."
    echo "   Or use 'git commit --no-verify' to bypass (not recommended)."
    exit 1
  fi
  
  echo "‚úÖ Static analysis passed"
else
  echo "‚ö†Ô∏è  Flutter not found in PATH, skipping analyze (CI will catch issues)"
fi

echo ""
echo "üîç Checking for secrets with gitleaks..."

# Check if gitleaks is installed
if command -v gitleaks >/dev/null 2>&1; then
  # Run gitleaks on staged files only
  # --staged flag scans only the files in the git staging area
  # --redact hides the actual secret values in output
  # -v shows verbose output
  gitleaks protect --staged --redact -v
  GITLEAKS_EXIT=$?
  
  if [ $GITLEAKS_EXIT -ne 0 ]; then
    echo ""
    echo "‚ùå Gitleaks found secrets in staged files!"
    echo ""
    echo "Common fixes:"
    echo "  ‚Ä¢ Move secrets to: env/dev.env.json (git-ignored)"
    echo "  ‚Ä¢ Use placeholders in docs: YOUR_API_KEY_HERE"
    echo "  ‚Ä¢ Add to .gitleaksignore if false positive"
    echo ""
    echo "See: docs/API_KEY_SETUP.md"
    echo ""
    echo "To bypass (if false positive): git commit --no-verify"
    exit 1
  fi
  
  echo "‚úÖ No secrets detected by gitleaks"
else
  echo "‚ö†Ô∏è  Gitleaks not installed, using basic pattern matching..."
  echo "   Install: brew install gitleaks"
  echo ""
  
  # Fallback to basic pattern matching if gitleaks not available
  STAGED_FILES=$(git diff --cached --name-only)
  
  if [ -z "$STAGED_FILES" ]; then
    echo "‚úÖ No files staged"
    exit 0
  fi
  
  # Check for Google Maps API keys
  if echo "$STAGED_FILES" | xargs grep -l -E "AIzaSy[0-9A-Za-z_-]{33}" 2>/dev/null | grep -v "YOUR_.*_KEY_HERE\|PLACEHOLDER\|example\."; then
    echo ""
    echo "‚ùå ERROR: Google Maps API key detected!"
    echo ""
    echo "API keys must be in git-ignored files:"
    echo "  - env/dev.env.json (local development)"
    echo "  - android/local.properties (Android builds)"
    echo "  - GitHub Secrets (CI/CD)"
    echo ""
    echo "See: docs/API_KEY_SETUP.md"
    echo ""
    echo "To bypass (if false positive): git commit --no-verify"
    exit 1
  fi
  
  # Check for secret files that should be git-ignored
  if echo "$STAGED_FILES" | grep -E "^(env/dev\.env\.json|android/local\.properties)$"; then
    echo ""
    echo "‚ùå ERROR: Secret files are staged!"
    echo ""
    echo "These files should be git-ignored:"
    echo "$STAGED_FILES" | grep -E "^(env/dev\.env\.json|android/local\.properties)$" | sed 's/^/  - /'
    echo ""
    echo "To unstage: git reset HEAD <file>"
    exit 1
  fi
  
  # Check for AWS keys
  if echo "$STAGED_FILES" | xargs grep -l -E "(AKIA|ASIA)[0-9A-Z]{16}" 2>/dev/null; then
    echo ""
    echo "‚ùå ERROR: AWS access key detected!"
    echo ""
    echo "To bypass (if false positive): git commit --no-verify"
    exit 1
  fi
  
  # Check for GitHub tokens
  if echo "$STAGED_FILES" | xargs grep -l -E "(ghp_|gho_|ghu_|ghs_|ghr_)[0-9A-Za-z]{36,255}" 2>/dev/null; then
    echo ""
    echo "‚ùå ERROR: GitHub token detected!"
    echo ""
    echo "To bypass (if false positive): git commit --no-verify"
    exit 1
  fi
  
  echo "‚úÖ No secrets detected (basic scan)"
fi

exit 0
