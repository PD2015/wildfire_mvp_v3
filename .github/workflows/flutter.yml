name: Flutter CI/CD

on:
  push:
    branches: [ main, staging, 'feature/*', '**-a*-**' ]
  pull_request:
    branches: [ main, staging ]

permissions:
  checks: write
  contents: read
  pull-requests: write

jobs:
  # Core quality gates - must pass before any deployment
  build:
    name: Quality Gates (Format, Analyze, Test)
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch full history for gitleaks commit range analysis

      - name: Set up Java (for Android toolchain)
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.35.5'
          channel: 'stable'
          cache: true

      - name: Cache pub dependencies
        uses: actions/cache@v3
        with:
          path: |
            ${{ env.PUB_CACHE }}
            ~/.pub-cache
          key: ${{ runner.os }}-pub-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-pub-

      - name: Get dependencies
        run: flutter pub get

      - name: Format check (C1)
        run: |
          dart format --output=none --set-exit-if-changed .

      - name: Analyze (C1)
        run: flutter analyze

      - name: Run tests (C1, C5)
        run: |
          # Run unit and integration tests (skip widget golden tests due to platform rendering differences)
          flutter test test/unit/ --platform=chrome --reporter expanded
          flutter test test/integration/ --platform=chrome --reporter expanded

      - name: LocationResolver tests (A4 validation)
        run: |
          echo "Running A4 LocationResolver test suite..."
          flutter test test/unit/services/location_resolver_test.dart --platform=chrome
          flutter test test/widget/manual_location_dialog_test.dart --platform=chrome
          flutter test test/integration/location_flow_test.dart --platform=chrome

      - name: Secret scan with gitleaks (C2)
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          args: detect --source . --no-git -v

      - name: Optional color/palette guard (C4)
        shell: bash
        run: |
          if [ -x scripts/color_guard.sh ]; then
            scripts/color_guard.sh
          else
            echo "No color_guard.sh found; skipping palette check.";
          fi

      - name: Upload test results (always)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            **/coverage/**
            **/test/**/golden/**

  # Verify iOS Xcode build phase automation (A12b)
  verify-ios-build-phase:
    name: Verify iOS Xcode Build Phase
    runs-on: macos-latest
    needs: [build]
    timeout-minutes: 20
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.35.5'
        channel: 'stable'
        cache: true
    
    - name: Cache pub dependencies
      uses: actions/cache@v3
      with:
        path: |
          ${{ env.PUB_CACHE }}
          ~/.pub-cache
        key: ${{ runner.os }}-pub-${{ hashFiles('**/pubspec.lock') }}
        restore-keys: |
          ${{ runner.os }}-pub-
    
    - name: Get dependencies
      run: flutter pub get
    
    - name: Create test environment file
      run: |
        cat > env/ci.env.json << EOF
        {
          "GOOGLE_MAPS_API_KEY_IOS": "${{ secrets.GOOGLE_MAPS_API_KEY_IOS_CI || 'AIzaSyDEFAULT_CI_KEY_FOR_BUILD_TEST_ONLY' }}",
          "GOOGLE_MAPS_API_KEY_ANDROID": "AIzaSyDEFAULT_ANDROID_KEY",
          "GOOGLE_MAPS_API_KEY_WEB": "AIzaSyDEFAULT_WEB_KEY",
          "MAP_LIVE_DATA": "false",
          "EFFIS_BASE_URL": "https://ies-ows.jrc.ec.europa.eu/"
        }
        EOF
        echo "‚úÖ Created CI environment file"
    
    - name: Verify prebuild scripts exist and are executable
      run: |
        echo "üîç Checking prebuild scripts..."
        
        if [ ! -f "ios/ios_prebuild.sh" ]; then
          echo "‚ùå ios_prebuild.sh not found"
          exit 1
        fi
        
        if [ ! -f "ios/xcode_build_phase_script.sh" ]; then
          echo "‚ùå xcode_build_phase_script.sh not found"
          exit 1
        fi
        
        if [ ! -x "ios/ios_prebuild.sh" ]; then
          echo "‚ö†Ô∏è  ios_prebuild.sh not executable, fixing..."
          chmod +x ios/ios_prebuild.sh
        fi
        
        if [ ! -x "ios/xcode_build_phase_script.sh" ]; then
          echo "‚ö†Ô∏è  xcode_build_phase_script.sh not executable, fixing..."
          chmod +x ios/xcode_build_phase_script.sh
        fi
        
        echo "‚úÖ Prebuild scripts verified"
    
    - name: Verify Info.plist has placeholder
      run: |
        echo "üîç Checking Info.plist for placeholder..."
        
        if grep -q "\${GOOGLE_MAPS_API_KEY_IOS}" ios/Runner/Info.plist; then
          echo "‚úÖ Info.plist contains placeholder (no hardcoded key)"
        else
          echo "‚ö†Ô∏è  Warning: Info.plist may not have correct placeholder"
          grep -A2 -B2 "GMSApiKey" ios/Runner/Info.plist || echo "GMSApiKey not found in Info.plist"
        fi
    
    - name: Generate Flutter build configuration
      run: |
        echo "üîß Running flutter build to generate Generated.xcconfig..."
        flutter build ios --config-only --dart-define-from-file=env/ci.env.json --no-codesign
        echo "‚úÖ Generated.xcconfig created"
    
    - name: Verify Generated.xcconfig contains DART_DEFINES
      run: |
        echo "üîç Checking Generated.xcconfig..."
        
        if [ ! -f "ios/Flutter/Generated.xcconfig" ]; then
          echo "‚ùå Generated.xcconfig not found"
          exit 1
        fi
        
        if grep -q "DART_DEFINES=" ios/Flutter/Generated.xcconfig; then
          echo "‚úÖ DART_DEFINES found in Generated.xcconfig"
          echo "First 100 chars of DART_DEFINES:"
          grep "DART_DEFINES=" ios/Flutter/Generated.xcconfig | head -c 100
          echo "..."
        else
          echo "‚ùå DART_DEFINES not found in Generated.xcconfig"
          exit 1
        fi
    
    - name: Test prebuild script manually
      run: |
        echo "üß™ Testing ios_prebuild.sh manually..."
        
        # Set required environment variables for the script
        export SRCROOT="$(pwd)/ios"
        
        # Make backup of Info.plist
        cp ios/Runner/Info.plist ios/Runner/Info.plist.backup
        
        # Run the prebuild script
        cd ios
        ./ios_prebuild.sh
        
        echo "‚úÖ Prebuild script executed successfully"
    
    - name: Verify API key was injected into Info.plist
      run: |
        echo "üîç Verifying API key injection..."
        
        # Check if GMSApiKey was updated (should no longer be placeholder)
        if /usr/libexec/PlistBuddy -c "Print :GMSApiKey" ios/Runner/Info.plist | grep -q "AIzaSy"; then
          echo "‚úÖ API key successfully injected into Info.plist"
          # Show first 20 chars only for security
          INJECTED_KEY=$(/usr/libexec/PlistBuddy -c "Print :GMSApiKey" ios/Runner/Info.plist)
          echo "Injected key: ${INJECTED_KEY:0:20}***"
        else
          echo "‚ùå API key not properly injected"
          /usr/libexec/PlistBuddy -c "Print :GMSApiKey" ios/Runner/Info.plist
          exit 1
        fi
        
        # Restore backup
        mv ios/Runner/Info.plist.backup ios/Runner/Info.plist
        echo "‚úÖ Restored Info.plist from backup"
    
    - name: Test full iOS build with build phase
      run: |
        echo "üèóÔ∏è  Testing full iOS build with Xcode build phase..."
        
        # Attempt to build iOS (config only, no actual compilation)
        flutter build ios \
          --dart-define-from-file=env/ci.env.json \
          --no-codesign \
          --debug \
          --config-only
        
        echo "‚úÖ iOS build configuration successful"
    
    - name: Verify AppDelegate can read API key
      run: |
        echo "üîç Checking AppDelegate.swift for correct API key reading pattern..."
        
        if grep -q "Bundle.main.object(forInfoDictionaryKey: \"GMSApiKey\")" ios/Runner/AppDelegate.swift; then
          echo "‚úÖ AppDelegate uses correct Info.plist key reading pattern"
        else
          echo "‚ö†Ô∏è  AppDelegate may not be reading GMSApiKey from Info.plist correctly"
          grep -A5 -B5 "GMSServices" ios/Runner/AppDelegate.swift || echo "GMSServices not found"
        fi
    
    - name: Summary
      if: always()
      run: |
        echo "üìä iOS Build Phase Verification Summary"
        echo "========================================"
        echo "‚úÖ Prebuild scripts exist and are executable"
        echo "‚úÖ Info.plist has placeholder (no hardcoded secrets)"
        echo "‚úÖ Generated.xcconfig contains DART_DEFINES"
        echo "‚úÖ Prebuild script successfully extracts and injects API key"
        echo "‚úÖ API key injection verified in Info.plist"
        echo "‚úÖ Full iOS build configuration successful"
        echo "‚úÖ AppDelegate reads API key correctly"
        echo ""
        echo "üéâ All iOS Xcode build phase checks passed!"

  # Constitutional compliance checks
  constitutional-compliance:
    name: Constitutional Compliance (C1-C5)
    runs-on: ubuntu-latest
    needs: [build]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
      
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.35.5'
        channel: 'stable'
        cache: true
        
    - name: Cache pub dependencies
      uses: actions/cache@v3
      with:
        path: |
          ${{ env.PUB_CACHE }}
          ~/.pub-cache
        key: ${{ runner.os }}-pub-${{ hashFiles('**/pubspec.lock') }}
        restore-keys: |
          ${{ runner.os }}-pub-
          
    - name: Get dependencies
      run: flutter pub get
      
    - name: Check for hardcoded secrets (C2 compliance)
      run: |
        if grep -R --include="*.dart" -E "(api_key|apiKey|API_KEY|secret|Secret|SECRET|password|Password|PASSWORD|token|Token|TOKEN).*=.*['\"]" lib/; then
          echo "‚ùå C2 FAIL: Hardcoded secret detected"
          exit 1
        else
          echo "‚úÖ C2 PASS: No hardcoded secrets found"
        fi
      
    - name: Verify accessibility compliance (C3)
      run: |
        echo "üîç Checking for accessibility compliance..."
        
        # Check for semantic labels in widgets
        if ! grep -r "Semantics\|semanticLabel\|excludeSemantics" lib/ > /dev/null; then
          echo "‚ö†Ô∏è  C3 WARNING: No semantic labels found, verify accessibility"
        else
          echo "‚úÖ C3 PASS: Semantic labels detected"
        fi
        
        # Check for proper touch target sizes
        if ! grep -r "kMinInteractiveDimension\|44\|48" test/ > /dev/null; then
          echo "‚ö†Ô∏è  C3 WARNING: No touch target size tests found"
        else
          echo "‚úÖ C3 PASS: Touch target size tests detected"
        fi
        
    - name: Verify transparency compliance (C4)
      run: |
        echo "üîç Checking for transparency compliance..."
        
        # Check for timestamp display
        if ! grep -r "Updated\|Cached\|timestamp\|observedAt" lib/ > /dev/null; then
          echo "‚ùå C4 FAIL: No timestamp/freshness indicators found"
          exit 1
        else
          echo "‚úÖ C4 PASS: Timestamp indicators found"
        fi
        
        # Check for source labeling
        if ! grep -r "source\|Source\|EFFIS\|SEPA\|Mock" lib/ > /dev/null; then
          echo "‚ùå C4 FAIL: No data source labeling found"
          exit 1
        else
          echo "‚úÖ C4 PASS: Data source labeling found"
        fi
        
    - name: Verify resilience compliance (C5)
      run: |
        echo "üîç Checking for resilience compliance..."
        
        # Check for error handling
        if ! grep -r "try\|catch\|Either\|Left\|Right" lib/ > /dev/null; then
          echo "‚ùå C5 FAIL: No error handling patterns found"
          exit 1
        else
          echo "‚úÖ C5 PASS: Error handling patterns found"
        fi
        
        # Check for retry mechanisms
        if ! grep -r "retry\|Retry\|fallback\|Fallback" lib/ > /dev/null; then
          echo "‚ùå C5 FAIL: No retry/fallback mechanisms found"
          exit 1
        else
          echo "‚úÖ C5 PASS: Retry/fallback mechanisms found"
        fi

  # Web build with API key injection (A11)
  build-web:
    name: Build Web Artifact
    needs: [build, constitutional-compliance]
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.35.5'
          channel: 'stable'
      
      - name: Get dependencies
        run: flutter pub get
      
      - name: Build web with API key injection (Preview)
        if: github.event_name == 'pull_request'
        env:
          MAPS_API_KEY_WEB: ${{ secrets.GOOGLE_MAPS_API_KEY_WEB_PREVIEW }}
        run: ./scripts/build_web_ci.sh
      
      - name: Build web with API key injection (Staging)
        if: github.event_name == 'push' && github.ref == 'refs/heads/staging'
        env:
          MAPS_API_KEY_WEB: ${{ secrets.GOOGLE_MAPS_API_KEY_WEB_PREVIEW }}
        run: ./scripts/build_web_ci.sh
      
      - name: Build web with API key injection (Production)
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        env:
          MAPS_API_KEY_WEB: ${{ secrets.GOOGLE_MAPS_API_KEY_WEB_PRODUCTION }}
        run: ./scripts/build_web_ci.sh
      
      - name: Upload web artifact
        uses: actions/upload-artifact@v4
        with:
          name: web-build
          path: build/web/
          retention-days: 7

  # Deploy to Firebase preview channel for PRs (A11)
  deploy-preview:
    name: Deploy Preview Channel
    needs: build-web
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      preview_url: ${{ steps.deploy.outputs.details_url }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download web artifact
        uses: actions/download-artifact@v4
        with:
          name: web-build
          path: build/web/
      
      - name: Deploy to Firebase preview channel
        id: deploy
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: '${{ secrets.GITHUB_TOKEN }}'
          firebaseServiceAccount: '${{ secrets.FIREBASE_SERVICE_ACCOUNT }}'
          projectId: '${{ secrets.FIREBASE_PROJECT_ID }}'
          channelId: 'pr-${{ github.event.pull_request.number }}'
          expires: 7d

  # Run integration tests against deployed preview (A11)
  test-preview:
    name: Test Preview Deployment
    needs: deploy-preview
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4
      
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.35.5'
          channel: 'stable'
          cache: true
      
      - name: Install dependencies
        run: flutter pub get
      
      - name: Run integration tests against preview URL
        run: |
          flutter test integration_test/report_fire_integration_test.dart \
            --dart-define=TEST_TARGET_URL=${{ needs.deploy-preview.outputs.preview_url }} \
            --platform=chrome
        continue-on-error: true
        # Note: Tests may fail if Google Maps API restrictions don't include preview URLs
        # Add preview URL pattern to Google Cloud Console HTTP referrer restrictions

  # Deploy to staging environment (auto-deploy on push to staging) (A11)
  deploy-staging:
    name: Deploy Staging Environment
    needs: build-web
    if: github.event_name == 'push' && github.ref == 'refs/heads/staging'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    environment:
      name: staging
      url: https://wildfire-app-e11f8-staging.web.app
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Download web artifact
        uses: actions/download-artifact@v4
        with:
          name: web-build
          path: build/web/
      
      - name: Deploy to staging channel
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: '${{ secrets.GITHUB_TOKEN }}'
          firebaseServiceAccount: '${{ secrets.FIREBASE_SERVICE_ACCOUNT }}'
          projectId: '${{ secrets.FIREBASE_PROJECT_ID }}'
          channelId: staging
          expires: 90d

  # Deploy to production (requires manual approval) (A11)
  deploy-production:
    name: Deploy Production
    needs: build-web
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    environment:
      name: production
      url: https://wildfire-app-e11f8.web.app
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Download web artifact
        uses: actions/download-artifact@v4
        with:
          name: web-build
          path: build/web/
      
      - name: Deploy to Firebase production
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: '${{ secrets.GITHUB_TOKEN }}'
          firebaseServiceAccount: '${{ secrets.FIREBASE_SERVICE_ACCOUNT }}'
          projectId: '${{ secrets.FIREBASE_PROJECT_ID }}'
          channelId: live
